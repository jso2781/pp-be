<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.kids.domain.auth.mapper.MbrTokenMapper">

    <select id="nextMbrTokenId" resultType="long">
        SELECT nextval('kids_own.sq_ca_token_id_1')
    </select>

    <select id="getMbrToken" parameterType="MbrTokenPVO" resultType="MbrTokenRVO" >
        /* 대국민포털_회원_TOKEN 조회 (MbrTokenMapper.getMbrToken) */
        SELECT
             token_id
            ,mbr_id
            ,app_id
            ,refresh_token
            ,access_token
            ,rgtr_id
            ,reg_dt

            ,mdfr_id
            ,mdfcn_dt

        FROM kids_own.tb_ca_m_mbr_token
        WHERE 1=1
        AND token_id = #{tokenId}
    </select>

    <insert id="insertMbrToken" parameterType="MbrTokenPVO">
        /* 대국민포털_회원_TOKEN 입력 (MbrTokenMapper.insertMbrToken) */
        INSERT INTO kids_own.tb_ca_m_mbr_token
        (
             token_id
            ,mbr_id
            ,app_id
            ,refresh_token
            ,access_token
            ,rgtr_id
            ,reg_dt

            ,mdfr_id
            ,mdfcn_dt

        )
        VALUES
        (
             #{tokenId}
            ,#{mbrId}
            ,#{appId}
            ,#{refreshToken}
            ,#{accessToken}
            ,#{rgtrId}
            ,now()

            ,#{mdfrId}
            ,now()

        )
    </insert>

    <update id="updateMbrToken" parameterType="MbrTokenPVO">
        /* 대국민포털_회원_TOKEN 수정 (MbrTokenMapper.updateMbrToken) */
        UPDATE kids_own.tb_ca_m_mbr_token
        SET
             app_id = coalesce(#{appId}, app_id)
            ,refresh_token = coalesce(#{refreshToken}, refresh_token)
            ,access_token = coalesce(#{accessToken}, access_token)
            ,mdfr_id = coalesce(#{mdfrId}, mdfr_id)
            ,mdfcn_dt = now()

        WHERE 1=1
        AND token_id = #{tokenId}
    </update>

    <insert id="saveMbrToken" parameterType="MbrTokenPVO">
        /* 대국민포털_회원_TOKEN 저장 (MbrTokenMapper.insertMbrToken) */
        INSERT INTO kids_own.tb_ca_m_mbr_token
        (
             token_id
            ,mbr_id
            ,app_id
            ,refresh_token
            ,access_token
            ,rgtr_id
            ,reg_dt

            ,mdfr_id
            ,mdfcn_dt

        )
        VALUES
        (
             #{tokenId}
            ,#{mbrId}
            ,#{appId}
            ,#{refreshToken}
            ,#{accessToken}
            ,#{rgtrId}
            ,now()

            ,#{mdfrId}
            ,now()

        )
        ON CONFLICT(token_id)
        DO UPDATE SET
             mbr_id = coalesce(excluded.mbr_id, kids_own.tb_ca_m_mbr_token.mbr_id)
            ,app_id = coalesce(excluded.app_id, kids_own.tb_ca_m_mbr_token.app_id)
            ,refresh_token = coalesce(excluded.refresh_token, kids_own.tb_ca_m_mbr_token.refresh_token)
            ,access_token = coalesce(excluded.access_token, kids_own.tb_ca_m_mbr_token.access_token)
            ,mdfr_id = coalesce(excluded.mdfr_id, kids_own.tb_ca_m_mbr_token.mdfr_id)
            ,mdfcn_dt = now()

    </insert>

    <delete id="deleteMbrToken" parameterType="MbrTokenDVO">
        /* 대국민포털_회원_TOKEN 삭제 (MbrTokenMapper.deleteMbrToken) */
        DELETE FROM kids_own.tb_ca_m_mbr_token
        WHERE 1=1
        AND token_id = #{tokenId}
        AND mbr_id = #{mbrId}
    </delete>

</mapper>