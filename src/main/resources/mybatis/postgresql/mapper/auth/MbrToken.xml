<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.kids.domain.auth.mapper.MbrTokenMapper">

    <select id="nextMbrTokenId" resultType="long">
        SELECT nextval('"KIDS_OWN"."TB_PP_M_MBR_TOKEN_SEQ"')
    </select>

    <select id="getMbrToken" parameterType="MbrTokenPVO" resultType="MbrTokenRVO" >
        /* 대국민포털_회원_TOKEN 조회 (MbrTokenMapper.getMbrToken) */
        SELECT
             token_id
            ,mbr_id
            ,app_id
            ,refresh_token
            ,access_token
            ,rgtr_id
            ,reg_dt
            ,reg_prgrm_id
            ,mdfr_id
            ,mdfcn_dt
            ,mdfcn_prgrm_id
        FROM "KIDS_OWN"."TB_PP_M_MBR_TOKEN"
        WHERE 1=1
        AND token_id = #{tokenId}
    </select>

    <insert id="insertMbrToken" parameterType="MbrTokenPVO">
        /* 대국민포털_회원_TOKEN 입력 (MbrTokenMapper.insertMbrToken) */
        INSERT INTO "KIDS_OWN"."TB_PP_M_MBR_TOKEN"
        (
             token_id
            ,mbr_id
            ,app_id
            ,refresh_token
            ,access_token
            ,rgtr_id
            ,reg_dt
            ,reg_prgrm_id
            ,mdfr_id
            ,mdfcn_dt
            ,mdfcn_prgrm_id
        )
        VALUES
        (
             #{tokenId}
            ,#{mbrId}
            ,#{appId}
            ,#{refreshToken}
            ,#{accessToken}
            ,#{rgtrId}
            ,now()
            ,#{regPrgrmId}
            ,#{mdfrId}
            ,now()
            ,#{mdfcnPrgrmId}
        )
    </insert>

    <update id="updateMbrToken" parameterType="MbrTokenPVO">
        /* 대국민포털_회원_TOKEN 수정 (MbrTokenMapper.updateMbrToken) */
        UPDATE "KIDS_OWN"."TB_PP_M_MBR_TOKEN"
        SET
             app_id = coalesce(#{appId}, app_id)
            ,refresh_token = coalesce(#{refreshToken}, refresh_token)
            ,access_token = coalesce(#{accessToken}, access_token)
            ,mdfr_id = coalesce(#{mdfrId}, mdfr_id)
            ,mdfcn_dt = now()
            ,mdfcn_prgrm_id = coalesce(#{mdfcnPrgrmId}, mdfcn_prgrm_id)
        WHERE 1=1
        AND token_id = #{tokenId}
    </update>

    <insert id="saveMbrToken" parameterType="MbrTokenPVO">
        /* 대국민포털_회원_TOKEN 저장 (MbrTokenMapper.insertMbrToken) */
        INSERT INTO "KIDS_OWN"."TB_PP_M_MBR_TOKEN"
        (
             token_id
            ,mbr_id
            ,app_id
            ,refresh_token
            ,access_token
            ,rgtr_id
            ,reg_dt
            ,reg_prgrm_id
            ,mdfr_id
            ,mdfcn_dt
            ,mdfcn_prgrm_id
        )
        VALUES
        (
             #{tokenId}
            ,#{mbrId}
            ,#{appId}
            ,#{refreshToken}
            ,#{accessToken}
            ,#{rgtrId}
            ,now()
            ,#{regPrgrmId}
            ,#{mdfrId}
            ,now()
            ,#{mdfcnPrgrmId}
        )
        ON CONFLICT(token_id)
        DO UPDATE SET
             mbr_id = coalesce(excluded.mbr_id, "KIDS_OWN"."TB_PP_M_MBR_TOKEN".mbr_id)
            ,app_id = coalesce(excluded.app_id, "KIDS_OWN"."TB_PP_M_MBR_TOKEN".app_id)
            ,refresh_token = coalesce(excluded.refresh_token, "KIDS_OWN"."TB_PP_M_MBR_TOKEN".refresh_token)
            ,access_token = coalesce(excluded.access_token, "KIDS_OWN"."TB_PP_M_MBR_TOKEN".access_token)
            ,mdfr_id = coalesce(excluded.mdfr_id, "KIDS_OWN"."TB_PP_M_MBR_TOKEN".mdfr_id)
            ,mdfcn_dt = now()
            ,mdfcn_prgrm_id = coalesce(excluded.mdfcn_prgrm_id, "KIDS_OWN"."TB_PP_M_MBR_TOKEN".mdfcn_prgrm_id)
    </insert>

    <delete id="deleteMbrToken" parameterType="MbrTokenDVO">
        /* 대국민포털_회원_TOKEN 삭제 (MbrTokenMapper.deleteMbrToken) */
        DELETE FROM "KIDS_OWN"."TB_PP_M_MBR_TOKEN"
        WHERE 1=1
        AND token_id = #{tokenId}
    </delete>

</mapper>