<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.kids.domain.pp.dur.mapper.DurMyDrugInfoMapper">

    <select id="selectDurMyDrugSearchItemC1">
        /* 대국민포털_내가먹는약의DUR정보 의약품 검색 CASE1 (DurMyDrugInfoMapper.selectDurMyDrugSearchItemC1) */
        SELECT DISTINCT ON (st.item_seq)
               st.item_seq
             , substr(st.std_cd, 4, 9) AS std_cd
             , dit.item_name
             , dep.entp_name
          FROM us_dsadba.sp_drug_standard_code st
    INNER JOIN us_dsadba.drb_item dit ON dit.item_seq = st.item_seq
    INNER JOIN us_dsadba.dra_entp_permit dep ON dit.entp_seq = dep.entp_seq
         WHERE 1=1
           AND dit.item_name LIKE '%' || #{searchValue} || '%'
         ORDER BY st.item_seq
    </select>

    <select id="selectDurMyDrugSearchItemC2">
        /* 대국민포털_내가먹는약의DUR정보 의약품 검색 CASE2 (DurMyDrugInfoMapper.selectDurMyDrugSearchItemC2) */
        SELECT DISTINCT ON (st.item_seq)
               st.item_seq
             , substr(st.std_cd, 4, 9) AS std_cd
             , din.ingr_eng_name
             , dit.item_name
             , dep.entp_name
             , din.ingr_code
          FROM (SELECT DISTINCT ON (ingr_code)
                       ingr_code
                     , ingr_eng_name
                  FROM us_dsadba.drc_ingr
                 WHERE ingr_eng_name LIKE '%' || #{searchValue} || '%'
                   AND ori_material_yn = 'Y') din
    INNER JOIN us_dsadba.drb_item_ingr dii ON din.ingr_code = dii.material_code
    INNER JOIN us_dsadba.sp_drug_standard_code st ON dii.item_seq = st.item_seq
    INNER JOIN us_dsadba.drb_item dit ON dit.item_seq = st.item_seq
    INNER JOIN us_dsadba.dra_entp_permit dep ON dit.entp_seq = dep.entp_seq
         WHERE 1=1
           AND dii.material_mix_purpose_code = '001'
         ORDER BY st.item_seq, din.ingr_eng_name
    </select>

    <select id="selectDurMyDrugSearchItemC3">
        /* 대국민포털_내가먹는약의DUR정보 의약품 검색 CASE3 (DurMyDrugInfoMapper.selectDurMyDrugSearchItemC3) */
        SELECT DISTINCT ON (ingr_code)
               ingr_code
             , ingr_eng_name
          FROM us_dsadba.drc_ingr
         WHERE ingr_eng_name LIKE '%' || #{searchValue} || '%'
           AND ori_material_yn = 'Y'
         ORDER BY ingr_code, ingr_eng_name
    </select>


    <resultMap id="DurSearchRoomMap" type="kr.or.kids.domain.pp.dur.vo.DurSearchRoomRVO">
      <result property="igrdNm" column="igrd_nm"/>
      <result property="prdctNm" column="prdct_nm"/>
      <result property="concList" column="conc_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.ConcJsonArrayTypeHandler"/>
      <result property="ageList" column="age_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.AgeJsonArrayTypeHandler"/>
      <result property="prgntList" column="prgnt_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.PrgntJsonArrayTypeHandler"/>
      <result property="cpctList" column="cpct_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.CpctJsonArrayTypeHandler"/>
      <result property="dosageList" column="dosage_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.DosageJsonArrayTypeHandler"/>
      <result property="eftgrpList" column="eftgrp_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.EftgrpJsonArrayTypeHandler"/>
      <result property="snctzList" column="snctz_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.SnctzJsonArrayTypeHandler"/>
      <result property="nurswList" column="nursw_json_array" typeHandler="kr.or.kids.domain.pp.dur.mapper.typehandler.NurswJsonArrayTypeHandler"/>
    </resultMap>

    <!-- 입력 목록 중 하나라도 (제품명/성분명) 일치하면 포함. 공백이면 해당 항목은 조건 생략(=전부 허용). -->
    <sql id="condInList">
        <if test="durMyDrugInfoPVOs != null and durMyDrugInfoPVOs.size() > 0">
            AND (
            <foreach collection="durMyDrugInfoPVOs" item="item" separator=" OR ">
                (
                <choose><when test="item.prdctCd == null or item.prdctCd == ''">1=1</when><otherwise>prdct_cd = #{item.prdctCd}</otherwise></choose>
                AND
                <choose><when test="item.igrdCd == null or item.igrdCd == ''">1=1</when><otherwise>igrd_cd = #{item.igrdCd}</otherwise></choose>
                )
            </foreach>
            )
        </if>
    </sql>

    <select id="selectDurMyDrugInfoConcList" resultMap="DurSearchRoomMap">
        <choose>
            <when test="durMyDrugInfoPVOs != null and durMyDrugInfoPVOs.size() > 1">
                WITH input_items AS (
                    SELECT
                        row_number() OVER () AS rn,
                        x.prdct_cd,
                        x.igrd_cd
                    FROM (
                        <foreach collection="durMyDrugInfoPVOs" item="item" separator=" UNION ALL ">
                            SELECT
                                #{item.prdctCd}::varchar AS prdct_cd,
                                #{item.igrdCd}::varchar AS igrd_cd
                        </foreach>
                    ) x
                ),
                input_pairs AS (
                    SELECT
                        a.rn AS a_rn,
                        b.rn AS b_rn,
                        a.prdct_cd AS a_prdct_cd,
                        a.igrd_cd AS a_igrd_cd,
                        b.prdct_cd AS b_prdct_cd,
                        b.igrd_cd AS b_igrd_cd
                    FROM input_items a
                    JOIN input_items b ON a.rn &lt; b.rn
                ),
                conc_raw AS (
                    SELECT DISTINCT
                        CASE
                            WHEN (
                                (p.a_prdct_cd IS NULL OR p.a_prdct_cd = '' OR cb.prdct_cd_1 = p.a_prdct_cd)
                                AND (p.a_igrd_cd IS NULL OR p.a_igrd_cd = '' OR cb.igrd_cd_1 = p.a_igrd_cd)
                                AND (p.b_prdct_cd IS NULL OR p.b_prdct_cd = '' OR cb.prdct_cd_2 = p.b_prdct_cd)
                                AND (p.b_igrd_cd IS NULL OR p.b_igrd_cd = '' OR cb.igrd_cd_2 = p.b_igrd_cd)
                            ) THEN cb.prdct_nm_1
                            ELSE cb.prdct_nm_2
                        END AS prdct_nm,
                        CASE
                            WHEN (
                                (p.a_prdct_cd IS NULL OR p.a_prdct_cd = '' OR cb.prdct_cd_1 = p.a_prdct_cd)
                                AND (p.a_igrd_cd IS NULL OR p.a_igrd_cd = '' OR cb.igrd_cd_1 = p.a_igrd_cd)
                                AND (p.b_prdct_cd IS NULL OR p.b_prdct_cd = '' OR cb.prdct_cd_2 = p.b_prdct_cd)
                                AND (p.b_igrd_cd IS NULL OR p.b_igrd_cd = '' OR cb.igrd_cd_2 = p.b_igrd_cd)
                            ) THEN cb.igrd_nm_1
                            ELSE cb.igrd_nm_2
                        END AS igrd_nm,
                        CASE
                            WHEN (
                                (p.a_prdct_cd IS NULL OR p.a_prdct_cd = '' OR cb.prdct_cd_1 = p.a_prdct_cd)
                                AND (p.a_igrd_cd IS NULL OR p.a_igrd_cd = '' OR cb.igrd_cd_1 = p.a_igrd_cd)
                                AND (p.b_prdct_cd IS NULL OR p.b_prdct_cd = '' OR cb.prdct_cd_2 = p.b_prdct_cd)
                                AND (p.b_igrd_cd IS NULL OR p.b_igrd_cd = '' OR cb.igrd_cd_2 = p.b_igrd_cd)
                            ) THEN cb.igrd_nm_2
                            ELSE cb.igrd_nm_1
                        END AS prohibit_igrd_nm,
                        CASE
                            WHEN (
                                (p.a_prdct_cd IS NULL OR p.a_prdct_cd = '' OR cb.prdct_cd_1 = p.a_prdct_cd)
                                AND (p.a_igrd_cd IS NULL OR p.a_igrd_cd = '' OR cb.igrd_cd_1 = p.a_igrd_cd)
                                AND (p.b_prdct_cd IS NULL OR p.b_prdct_cd = '' OR cb.prdct_cd_2 = p.b_prdct_cd)
                                AND (p.b_igrd_cd IS NULL OR p.b_igrd_cd = '' OR cb.igrd_cd_2 = p.b_igrd_cd)
                            ) THEN cb.prdct_nm_2
                            ELSE cb.prdct_nm_1
                        END AS prohibit_prdct_nm,
                        cb.condi_rsn AS dtl_info_cn,
                        cb.rmrk_cn
                    FROM input_pairs p
                    JOIN kids_own.tb_pp_m_dur_conc_bann cb
                        ON cb.oper_stts_cd = 'O'
                       AND (
                            (
                                (p.a_prdct_cd IS NULL OR p.a_prdct_cd = '' OR cb.prdct_cd_1 = p.a_prdct_cd)
                                AND (p.a_igrd_cd IS NULL OR p.a_igrd_cd = '' OR cb.igrd_cd_1 = p.a_igrd_cd)
                                AND (p.b_prdct_cd IS NULL OR p.b_prdct_cd = '' OR cb.prdct_cd_2 = p.b_prdct_cd)
                                AND (p.b_igrd_cd IS NULL OR p.b_igrd_cd = '' OR cb.igrd_cd_2 = p.b_igrd_cd)
                            )
                            OR
                            (
                                (p.a_prdct_cd IS NULL OR p.a_prdct_cd = '' OR cb.prdct_cd_2 = p.a_prdct_cd)
                                AND (p.a_igrd_cd IS NULL OR p.a_igrd_cd = '' OR cb.igrd_cd_2 = p.a_igrd_cd)
                                AND (p.b_prdct_cd IS NULL OR p.b_prdct_cd = '' OR cb.prdct_cd_1 = p.b_prdct_cd)
                                AND (p.b_igrd_cd IS NULL OR p.b_igrd_cd = '' OR cb.igrd_cd_1 = p.b_igrd_cd)
                            )
                        )
                )
                SELECT
                    igrd_nm,
                    prdct_nm,
                    COALESCE(
                        jsonb_agg(
                            jsonb_build_object(
                                'prdct_nm', prdct_nm,
                                'igrd_nm', igrd_nm,
                                'prohibit_prdct_nm', prohibit_prdct_nm,
                                'prohibit_igrd_nm', prohibit_igrd_nm,
                                'dtl_info_cn', dtl_info_cn,
                                'rmrk_cn', rmrk_cn
                            )
                        ),
                        '[]'::jsonb
                    ) AS conc_json_array,
                    '[]'::jsonb AS age_json_array,
                    '[]'::jsonb AS prgnt_json_array,
                    '[]'::jsonb AS cpct_json_array,
                    '[]'::jsonb AS dosage_json_array,
                    '[]'::jsonb AS eftgrp_json_array,
                    '[]'::jsonb AS snctz_json_array,
                    '[]'::jsonb AS nursw_json_array
                FROM conc_raw
                GROUP BY igrd_nm, prdct_nm
            </when>
            <otherwise>
                SELECT
                    ''::varchar AS igrd_nm,
                    ''::varchar AS prdct_nm,
                    '[]'::jsonb AS conc_json_array,
                    '[]'::jsonb AS age_json_array,
                    '[]'::jsonb AS prgnt_json_array,
                    '[]'::jsonb AS cpct_json_array,
                    '[]'::jsonb AS dosage_json_array,
                    '[]'::jsonb AS eftgrp_json_array,
                    '[]'::jsonb AS snctz_json_array,
                    '[]'::jsonb AS nursw_json_array
                WHERE 1 = 0
            </otherwise>
        </choose>
    </select>

    <select id="selectDurMyDrugInfoList" resultMap="DurSearchRoomMap">
        SELECT
             igrd_nm
            ,prdct_nm
            ,'[]'::jsonb AS conc_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'rlvt_age', A.rlvt_age,
                        'rlvt_age_unit_nm', A.rlvt_age_unit_nm,
                        'age_prcs_cnd_nm', A.age_prcs_cnd_nm,
                        'dtl_info_cn', A.dtl_info_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'age'), '[]'::jsonb
             ) AS age_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'condi_grd_cd', A.condi_grd_cd,
                        'dtl_info_cn', A.dtl_info_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'prgnt'), '[]'::jsonb
             ) AS prgnt_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'day_max_admin_cpct', A.day_max_admin_cpct,
                        'dtl_info_cn', A.dtl_info_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'cpct'), '[]'::jsonb
             ) AS cpct_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'max_admin_prd_day_cnt', A.max_admin_prd_day_cnt,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'dosage'), '[]'::jsonb
             ) AS dosage_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'eff_group_nm', A.eff_group_nm,
                        'group_nm', A.group_nm
                    )
                ) FILTER (WHERE A.bann_type_cd = 'eftgrp'), '[]'::jsonb
             ) AS eftgrp_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'snctz'), '[]'::jsonb
             ) AS snctz_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'nursw'), '[]'::jsonb
             ) AS nursw_json_array
        FROM
        (
            /* 대국민포털_DUR연령금기기본 */
            SELECT
                    'age' as bann_type_cd
                    ,prdct_nm
                    ,igrd_nm
                    ,null as prohibit_igrd_nm
                    ,rlvt_age::varchar as rlvt_age
                    ,rlvt_age_unit_nm as rlvt_age_unit_nm
                    ,age_prcs_cnd_nm as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,dtl_info_cn as dtl_info_cn
                    ,null as rmrk_cn
            FROM kids_own.tb_pp_m_dur_age_bann
            WHERE oper_stts_cd = 'O'
            <include refid="condInList"/>
            UNION ALL
            /* 대국민포털_DUR임부금기기본 */
            SELECT
                    'prgnt' as bann_type_cd
                    ,prdct_nm
                    ,igrd_nm
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,condi_grd_cd as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,dtl_info_cn as dtl_info_cn
                    ,null as rmrk_cn
            FROM kids_own.tb_pp_m_dur_prgnt_bann
            WHERE oper_stts_cd = 'O'
            <include refid="condInList"/>
            UNION ALL
            /* 대국민포털_DUR용량주의기본 */
            SELECT
                    'cpct' as bann_type_cd
                    ,mdcn_nm as prdct_nm
                    ,gnrl_nm as igrd_nm
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,day_max_admin_cpct_cn || ' ' || day_max_admin_crtr_cpct as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,dtl_cn as dtl_info_cn
                    ,null as rmrk_cn
            FROM kids_own.tb_pp_m_dur_cpct
            WHERE oper_stts_cd = 'O'
            <if test="durMyDrugInfoPVOs != null and durMyDrugInfoPVOs.size() > 0">
                AND (
                <foreach collection="durMyDrugInfoPVOs" item="item" separator=" OR ">
                    (
                    <choose><when test="item.prdctCd == null or item.prdctCd == ''">1=1</when><otherwise>(mdcn_cd = #{item.prdctCd})</otherwise></choose>
                    AND
                    <choose><when test="item.igrdCd == null or item.igrdCd == ''">1=1</when><otherwise>(gnrl_nm_cd = #{item.igrdCd} OR mfds_igrd_cd_cn = #{item.igrdCd})</otherwise></choose>
                    )
                </foreach>
                )
            </if>
            UNION ALL
            /* 대국민포털_DUR투여기간주의기본 */
            SELECT
                    'dosage' as bann_type_cd
                    ,mdcn_nm as prdct_nm
                    ,gnrl_nm as igrd_nm
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,max_admin_prd_day_cnt::varchar as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,null as dtl_info_cn
                    ,rmrk_cn
            FROM kids_own.tb_pp_m_dur_dosage
            WHERE oper_stts_cd = 'O'
            <if test="durMyDrugInfoPVOs != null and durMyDrugInfoPVOs.size() > 0">
                AND (
                <foreach collection="durMyDrugInfoPVOs" item="item" separator=" OR ">
                    (
                    <choose><when test="item.prdctCd == null or item.prdctCd == ''">1=1</when><otherwise>(mdcn_cd = #{item.prdctCd})</otherwise></choose>
                    AND
                    <choose><when test="item.igrdCd == null or item.igrdCd == ''">1=1</when><otherwise>(gnrl_nm_cd = #{item.igrdCd} OR mfds_igrd_cd_cn = #{item.igrdCd})</otherwise></choose>
                    )
                </foreach>
                )
            </if>
            UNION ALL
            /* 대국민포털_DUR효능군중복기본 */
            SELECT
                     bann_type_cd
                    ,prdct_nm
                    ,igrd_nm
                    ,prohibit_igrd_nm
                    ,rlvt_age
                    ,rlvt_age_unit_nm
                    ,age_prcs_cnd_nm
                    ,condi_grd_cd
                    ,day_max_admin_cpct
                    ,max_admin_prd_day_cnt
                    ,eff_group_nm
                    ,group_nm
                    ,dtl_info_cn
                    ,rmrk_cn
            FROM (
                SELECT
                    'eftgrp' as bann_type_cd
                    ,item_nm as prdct_nm
                    ,gnrl_nm as igrd_nm
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,eff_group_nm
                    ,group_nm
                    ,null as dtl_info_cn
                    ,null as rmrk_cn
                FROM kids_own.tb_pp_m_dur_eftgrp
                WHERE oper_stts_cd = 'O'
                AND group_nm_1 IN (
                    SELECT e.group_nm_1
                    FROM kids_own.tb_pp_m_dur_eftgrp e
                    WHERE oper_stts_cd = 'O'
                    <if test="durMyDrugInfoPVOs != null and durMyDrugInfoPVOs.size() > 0">
                        AND (
                        <foreach collection="durMyDrugInfoPVOs" item="item" separator=" OR ">
                            (
                            <choose><when test="item.prdctCd == null or item.prdctCd == ''">1=1</when><otherwise>(e.mdcn_cd = #{item.prdctCd})</otherwise></choose>
                            AND
                            <choose><when test="item.igrdCd == null or item.igrdCd == ''">1=1</when><otherwise>(e.gnrl_nm_cd = #{item.igrdCd})</otherwise></choose>
                            )
                        </foreach>
                        )
                    </if>
                )
            ) EFT
            UNION ALL
            /* 대국민포털_DUR노인주의기본 */
            SELECT
                    'snctz' as bann_type_cd
                    ,prdct_nm
                    ,igrd_nm
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,null as dtl_info_cn
                    ,rmrk_cn
            FROM kids_own.tb_pp_m_dur_snctz
            WHERE oper_stts_cd = 'O'
            <include refid="condInList"/>
            UNION ALL
            /* 대국민포털_DUR수유부주의기본 */
            SELECT
                    'nursw' as bann_type_cd
                    ,prdct_nm
                    ,igrd_nm
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,null as dtl_info_cn
                    ,rmrk_cn
            FROM kids_own.tb_pp_m_dur_nursw
            WHERE oper_stts_cd = 'O'
            <include refid="condInList"/>
        ) A
        GROUP BY A.igrd_nm, A.prdct_nm
    </select>
</mapper>
