<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.kids.domain.dur.mapper.DurSearchRoomMapper">

    <resultMap id="DurSearchRoomMap" type="kr.go.kids.domain.dur.vo.DurSearchRoomRVO">
      <result property="igrdNm" column="igrd_nm"/>
      <result property="prdctNm" column="prdct_nm"/>
      <result property="concList" column="conc_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.ConcJsonArrayTypeHandler"/>
      <result property="ageList" column="age_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.AgeJsonArrayTypeHandler"/>
      <result property="prgntList" column="prgnt_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.PrgntJsonArrayTypeHandler"/>
      <result property="cpctList" column="cpct_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.CpctJsonArrayTypeHandler"/>
      <result property="dosageList" column="dosage_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.DosageJsonArrayTypeHandler"/>
      <result property="eftgrpList" column="eftgrp_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.EftgrpJsonArrayTypeHandler"/>
      <result property="snctzList" column="snctz_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.SnctzJsonArrayTypeHandler"/>
      <result property="nurswList" column="nursw_json_array" typeHandler="kr.go.kids.domain.dur.mapper.typehandler.NurswJsonArrayTypeHandler"/>
    </resultMap>

    <select id="selectDurSearchRoomList" parameterType="DurSearchRoomPVO" resultMap="DurSearchRoomMap" >
        SELECT
             igrd_nm                /* 검색한 제품의 성분  */
            ,prdct_nm               /* 검색한 제품명 */
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'prohibit_igrd_nm', A.prohibit_igrd_nm,
                        'dtl_info_cn', A.dtl_info_cn,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'conc'), '[]'::jsonb
             ) AS conc_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'rlvt_age', A.rlvt_age,
                        'rlvt_age_unit_nm', A.rlvt_age_unit_nm,
                        'age_prcs_cnd_nm', A.age_prcs_cnd_nm,
                        'dtl_info_cn', A.dtl_info_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'age'), '[]'::jsonb
             ) AS age_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'condi_grd_cd', A.condi_grd_cd,
                        'dtl_info_cn', A.dtl_info_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'prgnt'), '[]'::jsonb
             ) AS prgnt_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'day_max_admin_cpct', A.day_max_admin_cpct,
                        'dtl_info_cn', A.dtl_info_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'cpct'), '[]'::jsonb
             ) AS cpct_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'max_admin_prd_day_cnt', A.max_admin_prd_day_cnt,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'dosage'), '[]'::jsonb
             ) AS dosage_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'eff_group_nm', A.eff_group_nm,
                        'group_nm', A.group_nm
                    )
                ) FILTER (WHERE A.bann_type_cd = 'eftgrp'), '[]'::jsonb
             ) AS eftgrp_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'snctz'), '[]'::jsonb
             ) AS snctz_json_array
            ,COALESCE(
                jsonb_agg(
                    jsonb_build_object(
                        'prdct_nm', A.prdct_nm,
                        'igrd_nm', A.igrd_nm,
                        'rmrk_cn', A.rmrk_cn
                    )
                ) FILTER (WHERE A.bann_type_cd = 'nursw'), '[]'::jsonb
             ) AS nursw_json_array
        FROM
        (
            /* 대국민포털_DUR병용금기기본 */
            select
                    'conc' as bann_type_cd
                    ,prdct_nm_1 as prdct_nm                         /* 검색한 제품명 */
                    ,igrd_nm_1 as igrd_nm                           /* 검색한 제품의 성분 */
                    ,igrd_nm_2 as prohibit_igrd_nm                  /* 병용금기 성분 */
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,condi_rsn as dtl_info_cn                       /* 상세정보 */
                    ,rmrk_cn                                        /* 비고 */
            FROM kids_own.tb_pp_m_dur_conc_bann
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND igrd_nm_1 like '%' || #{igrdNm} || '%'
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND prdct_nm_1 like '%' || #{prdctNm} || '%'
            </if>
            UNION ALL
            SELECT
                    'conc' as bann_type_cd
                    ,prdct_nm_2 as prdct_nm                         /* 검색한 제품명 */
                    ,igrd_nm_2 as igrd_nm                           /* 검색한 제품의 성분 */
                    ,igrd_nm_1 as prohibit_igrd_nm                  /* 병용금기 성분 */
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,condi_rsn as dtl_info_cn                       /* 상세정보 */
                    ,rmrk_cn                                        /* 비고 */
            FROM kids_own.tb_pp_m_dur_conc_bann
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND igrd_nm_2 like '%' || #{igrdNm} || '%'
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND prdct_nm_2 like '%' || #{prdctNm} || '%'
            </if>
            UNION ALL
            /* 대국민포털_DUR연령금기기본 */
            SELECT
                    'age' as bann_type_cd
                    ,prdct_nm                                       /* 검색한 제품명 */
                    ,igrd_nm                                        /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,rlvt_age::varchar                              /* 해당 연령 */ 
                    ,rlvt_age_unit_nm                               /* 해당 연령 단위명 */
                    ,age_prcs_cnd_nm                                /* 연령처리조건명 */
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,dtl_info_cn                                    /* 상세정보 */
                    ,null as rmrk_cn
            FROM kids_own.tb_pp_m_dur_age_bann
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND igrd_nm like '%' || #{igrdNm} || '%'
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND prdct_nm like '%' || #{prdctNm} || '%'
            </if>
            UNION ALL
            /* 대국민포털_DUR임부금기기본 */
            SELECT
                    'prgnt' as bann_type_cd
                    ,prdct_nm                                       /* 검색한 제품명 */
                    ,igrd_nm                                        /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,condi_grd_cd                                   /* 금기등급코드 */
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,dtl_info_cn                                    /* 상세정보 */
                    ,null as rmrk_cn
            FROM kids_own.tb_pp_m_dur_prgnt_bann
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND igrd_nm like '%' || #{igrdNm} || '%'
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND prdct_nm like '%' || #{prdctNm} || '%'
            </if>
            UNION ALL
            /* 대국민포털_DUR용량주의기본 */
            SELECT
                    'cpct' as bann_type_cd
                    ,mdcn_nm as prdct_nm                            /* 검색한 제품명 */
                    ,gnrl_nm as igrd_nm                             /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,day_max_admin_cpct_cn || ' ' || day_max_admin_crtr_cpct as day_max_admin_cpct        /* 1일 최대용량 */
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,dtl_cn as dtl_info_cn                          /* 상세정보(비고 대체) */
                    ,null as rmrk_cn
            FROM kids_own.tb_pp_m_dur_cpct
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND (gnrl_nm like '%' || #{igrdNm} || '%' OR mfds_igrd_nm_cn like '%' || #{igrdNm} || '%')
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND (mdcn_nm like '%' || #{prdctNm} || '%' OR mfds_prdct_nm like '%' || #{prdctNm} || '%')
            </if>
            UNION ALL
            /* 대국민포털_DUR투여기간주의기본 */
            SELECT
                    'dosage' as bann_type_cd
                    ,mdcn_nm as prdct_nm                            /* 검색한 제품명 */
                    ,gnrl_nm as igrd_nm                             /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,max_admin_prd_day_cnt::varchar                 /* 최대투여기간(일) */
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,null as dtl_info_cn
                    ,rmrk_cn                                        /* 비고 */
            FROM kids_own.tb_pp_m_dur_dosage
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND (gnrl_nm like '%' || #{igrdNm} || '%' OR mfds_igrd_nm_cn like '%' || #{igrdNm} || '%')
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND (mdcn_nm like '%' || #{prdctNm} || '%' OR mfds_prdct_nm like '%' || #{prdctNm} || '%')
            </if>
            UNION ALL
            /* 대국민포털_DUR효능군중복기본 */
            SELECT
                     bann_type_cd
                    ,prdct_nm                                       /* 검색한 제품명 */
                    ,igrd_nm                                        /* 검색한 제품의 성분 */
                    ,prohibit_igrd_nm
                    ,rlvt_age
                    ,rlvt_age_unit_nm
                    ,age_prcs_cnd_nm
                    ,condi_grd_cd
                    ,day_max_admin_cpct
                    ,max_admin_prd_day_cnt
                    ,eff_group_nm                                   /* 효능그룹명 */
                    ,group_nm                                       /* 계열(그룹명) */
                    ,dtl_info_cn
                    ,rmrk_cn
            FROM(
                SELECT
                    'eftgrp' as bann_type_cd
                    ,item_nm  as prdct_nm                           /* 검색한 제품명 */
                    ,gnrl_nm as igrd_nm                             /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,eff_group_nm                                   /* 효능그룹명 */
                    ,group_nm                                       /* 계열(그룹명) */
                    ,null as dtl_info_cn
                    ,null as rmrk_cn
	            FROM kids_own.tb_pp_m_dur_eftgrp
	            WHERE oper_stts_cd = 'O' 
                AND group_nm_1 IN(
	                SELECT
	                    e.group_nm_1                                       /* 그룹명_1 */
	                FROM kids_own.tb_pp_m_dur_eftgrp e
	                WHERE oper_stts_cd = 'O' 
	                <if test="igrdNm != null and igrdNm != ''">
	                    AND (e.gnrl_nm like '%' || #{igrdNm} || '%' OR e.mfds_igrd_nm_cn like '%' || #{igrdNm} || '%')
	                </if>
	                <if test="prdctNm != null and prdctNm != ''">
	                    AND (e.item_nm like '%' || #{prdctNm} || '%' OR e.mfds_prdct_nm like '%' || #{prdctNm} || '%')
	                </if>
                )
            ) EFT
            UNION ALL
            /* 대국민포털_DUR노인주의기본 */
            SELECT
                    'snctz' as bann_type_cd
                    ,prdct_nm                                       /* 검색한 제품명 */
                    ,igrd_nm                                        /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,null as dtl_info_cn
                    ,rmrk_cn                                        /* 비고 */
            FROM kids_own.tb_pp_m_dur_snctz
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND igrd_nm like '%' || #{igrdNm} || '%'
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND prdct_nm like '%' || #{prdctNm} || '%'
            </if>
            UNION ALL
            /* 대국민포털_DUR수유부주의기본 */
            SELECT
                    'nursw' as bann_type_cd
                    ,prdct_nm                                       /* 검색한 제품명 */
                    ,igrd_nm                                        /* 검색한 제품의 성분 */
                    ,null as prohibit_igrd_nm
                    ,null as rlvt_age
                    ,null as rlvt_age_unit_nm
                    ,null as age_prcs_cnd_nm
                    ,null as condi_grd_cd
                    ,null as day_max_admin_cpct
                    ,null as max_admin_prd_day_cnt
                    ,null as eff_group_nm
                    ,null as group_nm
                    ,null as dtl_info_cn
                    ,rmrk_cn                                        /* 비고 */
            FROM kids_own.tb_pp_m_dur_nursw
            WHERE oper_stts_cd = 'O'
            <if test="igrdNm != null and igrdNm != ''">
                AND igrd_nm like '%' || #{igrdNm} || '%'
            </if>
            <if test="prdctNm != null and prdctNm != ''">
                AND prdct_nm like '%' || #{prdctNm} || '%'
            </if>
        ) A
        GROUP BY A.igrd_nm
                ,A.prdct_nm
    </select>

    <select id="selectPrdctDetailList" parameterType="DurPrdctDetailPVO" resultType="DurPrdctDetailRVO">
        /* DUR병용금기 정보에서 제품별 제약회사 조회(성분명 조건) */
        select
             prdct_nm_1 as prdct_nm                         /* 제품명(제품명_1) */
            ,bzenty_nm_1 as bzenty_nm                       /* 제약회사(업체명_1) */
        FROM kids_own.tb_pp_m_dur_conc_bann
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND igrd_nm_1 = #{igrdNm}
        </if>
        AND 'conc' = #{bannTypeCd}
        UNION ALL
        SELECT
             prdct_nm_2 as prdct_nm                         /* 제품명(제품명_2) */
            ,bzenty_nm_2 as bzenty_nm                       /* 제약회사(업체명_2) */
        FROM kids_own.tb_pp_m_dur_conc_bann
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND igrd_nm_2 = #{igrdNm}
        </if>
        AND 'conc' = #{bannTypeCd}
        UNION ALL
        /* DUR연령금기 정보에서 제품별 제약회사 조회(성분명 조건) */
        SELECT
             prdct_nm                                       /* 제품명 */
            ,bzenty_nm                                      /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_age_bann
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND igrd_nm = #{igrdNm}
        </if>
        AND 'age' = #{bannTypeCd}
        UNION ALL
        /* DUR임부금기 정보에서 제품별 제약회사 조회(성분명 조건) */
        SELECT
             prdct_nm                                       /* 제품명 */
            ,bzenty_nm                                      /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_prgnt_bann
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND igrd_nm = #{igrdNm}
        </if>
        AND 'prgnt' = #{bannTypeCd}
        UNION ALL
        /* DUR용량주의 정보에서 제품별 제약회사 조회(성분명 조건) */
        SELECT
             coalesce(mdcn_nm, mfds_prdct_nm) as prdct_nm   /* 제품명 */
            ,'' as bzenty_nm                                /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_cpct
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND (gnrl_nm = #{igrdNm} OR mfds_igrd_nm_cn = #{igrdNm})
        </if>
        AND 'cpct' = #{bannTypeCd}
        UNION ALL
        /* DUR투여기간주의 정보에서 제품별 제약회사 조회(성분명 조건) */
        SELECT
             mdcn_nm as prdct_nm                            /* 제품명 */
            ,'' as bzenty_nm                                /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_dosage
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND (gnrl_nm = #{igrdNm} OR mfds_igrd_nm_cn = #{igrdNm})
        </if>
        AND 'dosage' = #{bannTypeCd}
        UNION ALL
        /* DUR효능군중복 정보에서 제품별 제약회사 조회(성분명에 대한 그룹명_1 소속 전체 제품 조회) */
        SELECT
             coalesce(item_nm, mfds_prdct_nm) as prdct_nm   /* 제품명 */
            ,bzenty_nm                                      /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_eftgrp
        WHERE oper_stts_cd = 'O' 
        AND group_nm_1 IN(
            SELECT
                e.group_nm_1    /* 그룹명_1 */
            FROM kids_own.tb_pp_m_dur_eftgrp e
            WHERE oper_stts_cd = 'O' 
            <if test="igrdNm != null and igrdNm != ''">
                AND (e.gnrl_nm = #{igrdNm} OR e.mfds_igrd_nm_cn = #{igrdNm})
            </if>
        )
        AND 'eftgrp' = #{bannTypeCd}
        UNION ALL
        /* DUR노인주의 정보에서 제품별 제약회사 조회(성분명 조건) */
        SELECT
             prdct_nm                                       /* 제품명 */
            ,bzenty_nm                                      /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_snctz
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND igrd_nm = #{igrdNm}
        </if>
        AND 'snctz' = #{bannTypeCd}
        UNION ALL
        /* DUR수유부주의 정보에서 제품별 제약회사 조회(성분명 조건) */
        SELECT
             prdct_nm                                       /* 제품명 */
            ,bzenty_nm                                      /* 제약회사(업체명) */
        FROM kids_own.tb_pp_m_dur_nursw
        WHERE oper_stts_cd = 'O'
        <if test="igrdNm != null and igrdNm != ''">
            AND igrd_nm = #{igrdNm}
        </if>
        AND 'nursw' = #{bannTypeCd}
    </select>

    <select id="selectEftgrpDetailList" parameterType="DurEftgrpDetailPVO" resultType="DurEftgrpDetailRVO">
        /* 효능군중복주의 상세 조회(특정 성분의 그룹1 기준으로 조회, 팝업용) */
        SELECT
             eff_group_nm                                   /* 효능그룹명 */
            ,group_nm                                       /* 계열(그룹명) */
            ,coalesce(gnrl_nm, mfds_igrd_nm_cn) as igrd_nm  /* 성분 */
        FROM kids_own.tb_pp_m_dur_eftgrp
        WHERE oper_stts_cd = 'O' 
        AND group_nm_1 IN(
            SELECT
                e.group_nm_1                /* 그룹명_1 */
            FROM kids_own.tb_pp_m_dur_eftgrp e
            WHERE oper_stts_cd = 'O' 
            <if test="igrdNm != null and igrdNm != ''">
                AND (e.gnrl_nm = #{igrdNm} OR e.mfds_igrd_nm_cn = #{igrdNm})
            </if>
        )
    </select>
</mapper>
