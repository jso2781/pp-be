<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.kids.domain.pp.exprt.mapper.ExprtTaskMapper">

    <select id="selectExprtInfo" parameterType="ExprtTaskPVO" resultType="ExprtTaskRVO" >
        /* 대국민포털_전문가내업무관리 전문가회원 정보 조회 (ExprtTaskMapper.selectExprtInfo) */
        SELECT ei.encpt_exprt_flnm
             , ei.aprv_stts_cd AS exprt_aprv_stts_code
             , (SELECT com_dtl_cd_nm
                FROM kids_own.TB_CA_C_DTL_CODE
                WHERE com_group_cd = 'PP000004'
                  AND com_dtl_cd = ei.aprv_stts_cd) AS exprt_aprv_stts_label
             , ei.rjct_rsn
             , ei.exprt_no
             , ei.mbr_no
             , ii.inst_nm
             , ii.brno
             , (SELECT date_trunc('second', MAX(reg_dt))
                  FROM kids_own.tb_ca_l_sesn_log_info_mng
                 WHERE srvc_user_id = ei.rgtr_id) AS last_lgn_dt
         FROM kids_own.TB_PP_M_EXPRT_INFO ei
            , kids_own.TB_PP_M_INST ii
        WHERE ei.exprt_no = (SELECT exprt_no
                               FROM kids_own.TB_PP_M_EXPRT_INFO
                              WHERE mbr_no = #{mbrNo}
                              ORDER BY reg_dt DESC
                              LIMIT 1)
          AND ii.del_yn = 'N'
          AND ei.brno = ii.brno
    </select>

    <select id="selectExprtTasks" parameterType="ExprtTaskPVO" resultType="ExprtTaskRVO" >
        /* 대국민포털_전문가내업무관리 전문가회원 업무 목록 조회 (ExprtTaskMapper.selectExprtTasks) */
        SELECT it.task_se_cd AS value
             , (SELECT com_dtl_cd_nm
                  FROM kids_own.TB_CA_C_DTL_CODE
                 WHERE com_group_cd = 'PP000013'
                   AND com_dtl_cd = it.task_se_cd) AS label
             , et.aprv_stts_cd AS task_aprv_stts_code
             , (SELECT com_dtl_cd_nm
                FROM kids_own.TB_CA_C_DTL_CODE
                WHERE com_group_cd = 'PP000004'
                  AND com_dtl_cd = et.aprv_stts_cd) AS task_aprv_stts_label
             , et.rjct_rsn
             , et.exprt_task_sn
             , it.bzmn_task_mng_no
          FROM kids_own.TB_PP_M_INST_TASK it
          LEFT OUTER JOIN kids_own.TB_PP_M_EXPRT_TASK et
            ON it.bzmn_task_mng_no = et.bzmn_task_mng_no
           AND et.exprt_no = #{exprtNo}
         WHERE it.brno = #{brno}
           AND it.use_yn = 'Y'
    </select>

    <delete id="deleteAllExprtTask" parameterType="ExprtTaskPVO">
        /* 대국민포털_전문가내업무관리 전문가회원 업무 전체 삭제 (ExprtTaskMapper.deleteAllExprtTask) */
        DELETE FROM kids_own.TB_PP_M_EXPRT_TASK
         WHERE exprt_no = #{exprtNo}
    </delete>

    <delete id="deleteExprtTask" parameterType="ExprtTaskPVO">
        /* 대국민포털_전문가내업무관리 전문가회원 업무 삭제 (ExprtTaskMapper.deleteExprtTask) */
        DELETE FROM kids_own.TB_PP_M_EXPRT_TASK
         WHERE exprt_task_sn = #{exprtTaskSn}
    </delete>

    <delete id="deleteAllExprtAuth" parameterType="ExprtTaskPVO">
        /* 대국민포털_전문가내업무관리 전문가회원 권한 전체 삭제 (ExprtTaskMapper.deleteExprtAuth) */
        DELETE FROM kids_own.TB_PP_M_EXPRT_AUTHRT
        WHERE mbr_no = #{mbrNo}
    </delete>

    <delete id="deleteExprtAuth" parameterType="ExprtTaskPVO">
        /* 대국민포털_전문가내업무관리 전문가회원 권한 삭제 (ExprtTaskMapper.deleteExprtAuth) */
        DELETE FROM kids_own.TB_PP_M_EXPRT_AUTHRT
        WHERE exprt_task_sn = #{exprtTaskSn}
    </delete>

    <delete id="deleteExprtInfo" parameterType="ExprtTaskPVO">
        /* 대국민포털_전문가내업무관리 전문가회원 정보 삭제 (ExprtTaskMapper.deleteExprtInfo) */
        DELETE FROM kids_own.TB_PP_M_EXPRT_INFO
         WHERE exprt_no = #{exprtNo}
    </delete>

    <insert id="insertExprtTask" parameterType="ExprtTaskPVO">
        /* 대국민포털_전문가내업무관리 전문가회원 업무 입력 (ExprtTaskMapper.insertExprtTask) */
        INSERT INTO kids_own.TB_PP_M_EXPRT_TASK
        (
             exprt_task_sn
            ,exprt_no
            ,bzmn_task_mng_no
            ,aprv_stts_cd
            ,rgtr_id
            ,reg_dt
            ,mdfr_id
            ,mdfcn_dt
        )
        VALUES
        (
            nextval('kids_own.sq_pp_exprt_task_sn')
            ,#{exprtNo}
            ,#{bzmnTaskMngNo}
            ,'W'
            ,#{mbrId}
            ,CURRENT_TIMESTAMP
            ,#{mbrId}
            ,CURRENT_TIMESTAMP
        )
    </insert>

    <select id="selectExprtMenus" parameterType="String" resultType="MenuRVO">
        /* 대국민포털_전문가내업무관리 업무시스템에 해당하는 메뉴 목록 조회 (ExprtTaskMapper.selectExprtMenus) */
        WITH RECURSIVE menu_tree AS (
        SELECT
        m.menu_sn,
        m.up_menu_sn,
        1 AS dep_level,
        m.menu_sn AS root_sn,
        m.menu_nm,
        m.menu_seq,
        (m.menu_sn::text) AS path,
        m.lang_se_cd
        FROM kids_own.TB_PP_M_MENU m
        WHERE m.menu_sn IN (SELECT am.menu_sn
                              FROM kids_own.tb_pp_m_exprt_authrt ea
                                 , kids_own.tb_pp_m_authrt_menu am
                             WHERE ea.mbr_no = #{mbrNo}
                               AND ea.authrt_cd = am.authrt_cd)
        AND m.use_yn = 'Y'
        AND m.up_menu_sn IS NULL
        UNION ALL
        SELECT
        c.menu_sn,
        c.up_menu_sn,
        p.dep_level + 1,
        p.root_sn,
        c.menu_nm,
        c.menu_seq,
        (p.path || ' > ' || c.menu_sn::text) AS path,
        c.lang_se_cd
        FROM kids_own.TB_PP_M_MENU c
        JOIN menu_tree p
        ON c.up_menu_sn = p.menu_sn
        WHERE c.menu_sn IN (SELECT am.menu_sn
                              FROM kids_own.tb_pp_m_exprt_authrt ea
                                 , kids_own.tb_pp_m_authrt_menu am
                             WHERE ea.mbr_no = #{mbrNo}
                               AND ea.authrt_cd = am.authrt_cd)
         AND c.use_yn = 'Y'
        )
        SELECT
        mt.menu_sn,
        mt.up_menu_sn,
        mt.dep_level,
        mt.root_sn,
        mt.path,
        mt.menu_nm,
        mt.menu_seq,
        mt.lang_se_cd,
        d.menu_url_addr,
        d.menu_npag_nm,
        d.prvc_incl_yn,
        d.dgstfn_exmn_yn,
        d.menu_expsr_yn,
        d.dept_info_expsr_yn,
        d.pic_info_expsr_yn,
        d.mobl_aplcn_yn,
        d.lgn_yn,
        d.encpt_pic_telno,
        d.menu_kogl_cprgt_type_cd,
        d.menu_pic_id,
        coalesce(emp.emp_nm, m.pic_flnm) as menu_pic_flnm,
        emp.dept_no as menu_tkcg_dept_no,
        coalesce(emp.dept_nm, m.pic_dept_nm) as menu_tkcg_dept_nm
        FROM menu_tree mt
        LEFT JOIN kids_own.tb_pp_m_menu m
        ON mt.menu_sn = m.menu_sn
        LEFT JOIN kids_own.TB_PP_D_MENU d
        ON d.menu_sn = mt.menu_sn
        LEFT JOIN (
        SELECT
        A.emp_no,
        A.emp_nm,
        A.dept_no,
        B.dept_nm
        FROM kids_own.tb_pp_m_emp_info A,
        kids_own.tb_pp_m_dept_info B
        WHERE A.dept_no = B.dept_no
        ) emp
        ON d.menu_pic_id = emp.emp_no
        WHERE 1=1
        ORDER by mt.root_sn, mt.path, mt.menu_seq, mt.menu_sn
    </select>

</mapper>