<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.kids.domain.exprt.mapper.ExprtApplyMapper">

    <select id="existsInstByBrno" parameterType="String" resultType="String" >
        /* 대국민포털_전문가회원전환신청관리 사업자등록번호 검증 (ExprtApplyMapper.existsInstByBrno) */
        SELECT inst_nm
          FROM kids_own.TB_PP_M_INST
         WHERE brno = #{brno}
    </select>

    <select id="selectInstTaskSystemByBrno" parameterType="String" resultType="ExprtApplyRVO" >
        /* 대국민포털_전문가회원전환신청관리 기관 업무시스템 목록조회 (ExprtApplyMapper.selectInstTaskSystemByBrno) */        
		<!--
		테이블 및 컬럼명 확정 반영 		
		SELECT cd.공통상세코드 AS value
		     , cd.공통상세코드명 AS label
		  FROM kids_own."공통_상세코드" cd
		  LEFT OUTER JOIN kids_own.TB_PP_M_INST_TASK tk
		    ON cd.공통_상세코드 = tk.task_se_cd
		 WHERE cd.공통그룹코드 컬럼명 = '공통그룹코드 값'
		   AND tk.brno = #{brno}
		   AND cd.use_yn = 'Y'
		 ORDER BY cd.정렬순서 desc
		 -->		 
		SELECT '업무시스템1' AS label, 'SYS1' AS value
		 UNION ALL
		SELECT '업무시스템2' AS label, 'SYS2' AS value		   		   
    </select>

    <select id="existsByEmail" parameterType="String" resultType="boolean" >
        /* 대국민포털_전문가회원전환신청관리 이메일 중복검사 (ExprtApplyMapper.existsByEmail) */        
		SELECT EXISTS (
		    SELECT 1
		      FROM kids_own.TB_PP_M_EXPRT_INFO
		     WHERE encpt_exprt_inst_eml_nm = #{email}
		)
    </select>

    <insert id="insertExprtInfo" parameterType="ExprtApplyIVO">
        /* 대국민포털_전문가회원전환신청관리 전문가정보기본 입력 (ExprtApplyMapper.insertExprtInfo) */
        INSERT INTO kids_own.TB_PP_M_EXPRT_INFO
        (
             exprt_no
            ,mbr_no
            ,brno
            ,encpt_exprt_flnm
            ,encpt_exprt_inst_eml_nm
            ,exprt_hdof_yn
            ,exprt_aprv_stts_yn
            ,atch_file_group_id
            ,rgtr_id
            ,reg_dt

        )
        VALUES
        (
             nextval('kids_own.sq_pp_exprt_no')
            ,#{mbrNo}
            ,#{brno}
            ,#{name}
            ,#{email}
            ,'Y'
            ,'N'
            ,#{atchFileGroupId}
            ,#{mbrId}
            ,CURRENT_TIMESTAMP
        )
        <selectKey keyProperty="exprtNo" resultType="String" order="AFTER">
            SELECT currval('kids_own.sq_pp_exprt_no')
        </selectKey>
    </insert>

    <insert id="insertExprtTask" parameterType="ExprtApplyIVO">
        /* 대국민포털_전문가회원전환신청관리 전문가업무기본 입력 (ExprtApplyMapper.insertExprtTask) */
        INSERT INTO kids_own.TB_PP_M_EXPRT_TASK
        (
             exprt_task_sn
            ,exprt_no
            ,bzmn_task_mng_no
            ,exprt_aprv_stts_yn
            ,use_yn
            ,rgtr_id
            ,reg_dt
        )
        VALUES        
	    <foreach collection="taskSystemCodes"
	             item="taskSystemCd"
	             separator=",">
	        (
	            nextval('kids_own.sq_pp_exprt_task_sn')
	            ,#{exprtNo}
                ,(SELECT bzmn_task_mng_no
                    FROM kids_own.TB_PP_M_INST_TASK
                   WHERE brno = #{brno}
                     AND task_se_cd = #{taskSystemCd})
	            ,'N'
                ,'Y'
	            ,#{mbrId}
	            ,CURRENT_TIMESTAMP
	        )
	    </foreach>                
    </insert>    

</mapper>